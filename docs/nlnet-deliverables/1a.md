# 1a. Comparative research of deployment options

For the NLnet-funded project “An OpenScience flavour of Bonfire on NixOS for preprints” where we are focused on building a replicable deployment of Bonfire that is linked to Sciety for preprint authors, reviewers and advocates, we are exploring NixOS to simplify deployment, ensuring environmental consistency, and strengthen our commitment to the Principles of Open Scholarly Infrastructure (POSI). By leveraging Nix/NixOS,  we aim to ensure that research groups and institutions can deploy Bonfire independently, without deep systems administration experience (albeit requiring minor understanding of the functional deployment model underlying Nix).

### Target Audience

Our primary audiences for this work include:
- Researchers actively reading preprints
- University IT teams  
- Grassroots collectives and preprint advocates

Many of these groups operate with limited technical resources, making deployment accessibility a critical usability and sustainability challenge.

## Current Status of Bonfire on NixOS

### Existing Implementation

The Bonfire repository currently includes a NixOS module, but these are explicitly marked as "experimental" and "not ready for production." There appears to be [community demand for Nix provisioning](https://indieweb.social/@eliasp@mastodon.social/114779517887340791), which is encouraging and, as the [Bonfire team notes](https://indieweb.social/@bonfire/114779746674786150): "The nix stuff in the repo was added by a couple contributors but not quite finished."

### Historical Development

Several existing issues document Nix development efforts:
- [Issue #405](https://github.com/bonfire-networks/bonfire-app/issues/405)
- [Issue #85](https://github.com/bonfire-networks/bonfire-app/issues/85)

The Bonfire team has documented that an [experimental flake can be used on recent Nix/NixOS systems with flakes enabled](https://docs.bonfirenetworks.org/deploy.html).

### Current Limitations

Several factors make the current Nix integration unsuitable for production use:

**Experimental Status**: NixOS modules are explicitly marked as "not ready for production." Nix Flakes themselves remain marked as unstable upstream.

**Security Concerns**: The current setup requires `sandbox = false`, which weakens build isolation.

**Incomplete Configuration**: The module expects secrets to be handled externally. There are no native options to declare secrets or credentials declaratively within NixOS.

**Limited Documentation**: Beyond basic examples, critical deployment concerns like TLS configuration, upgrades, and scaling are not addressed.

**Incomplete packaging status**: The flake provided in the main Bonfire repository is intended to provide Bonfire and its dependencies as native Nix packages which requires a big up front packaging effort. 

While it is possible to run Bonfire on NixOS currently, it requires significant implicit knowledge and hands-on effort. Our project aims to advance Nix development and document the process to make it more approachable for research communities interested in deploying preprint discussion spaces. It side steps the packaging effort by leveraging the release artifacts provided by the Bonfire team in the form of Docker images.

## Deployment Evaluation and Experiments

### Team and Approach

Giacomo and Mark undertook this evaluation in consultation with the core Bonfire team:
- **Giacomo**: Familiar with Nix and NixOS deployment, expertise in evaluating technical options
- **Mark**: New to Nix, focused on documenting feasibility, ease of implementation, and reproducibility for our target audience

Our methodology includes AI-assisted exploration and prototyping, with regular meetings to discuss findings and asynchronous communication through chat and our Bonfire instance.

### Research Activities

#### NixOS Learning

Unfamilar with nix/nixOS, mark documented his learning journey in a [blog post about learning Nix and NixOS](https://markalexanderwilliams.co.uk/posts/learning-nix-and-nixos/).

#### Local Installation Attempts

Mark worked with AI assistance to install NixOS via UTM (the macOS equivalent of QEMU). Initial [attempts with the existing flake encountered errors](https://github.com/themarkness/nix-playground/tree/main/nixos). This work was paused in favor of cloud deployment to enable collaboration between Mark and Giacomo, rather than progressing with limited knowledge on a single machine.

Local setup will be crucial for Sciety plugin development but is not directly related to NixOS deployment priorities for this task

#### Cloud Deployment Research

The NixOS documentation lists [cloud hosts](https://wiki.nixos.org/wiki/NixOS_friendly_hosters) with varying levels of NixOS support, from "first-class" support to "install from ISO" options and other less documented approaches.

Our deployment approach had two key goals:
1. **Collaboration**: Enable joint experimentation with reproducible configuration and minimal onboarding
2. **Vendor independence**: Ensure our approach works across NixOS-friendly hosts without lock-in

After evaluating providers including Oracle Cloud's free tier, considering factors like cost, data location (initially preferring EU hosting), and community support, we selected [Hetzner Cloud](https://www.hetzner.com/cloud/) for our experiments.

Hetzner Cloud offers:
- Competitive pricing
- One-click NixOS installation from ISO
- Easy remote access configuration enabling compatibility with tools like `nixos-anywhere`

This decision was made pragmatically, considering the constraints of our task and within a short evaluation window to enable progress without over-engineering the infrastructure layer. It should be stated that other providers may offer similar affordabilities but this would require further research.

## Hetzner Cloud Setup

Here's how we configured Hetzner VMs for our experiments

1. [**Create Hetzner Cloud account**](http://hetzner.com)
2. **Setup SSH keys**: Create and/or upload SSH keys to your Hetzner account
3. [**Create new machine**](https://docs.hetzner.com/cloud/servers/getting-started/creating-a-server/) with the following configuration:
   - Ubuntu image (will be overwritten with NixOS)
   - CX22 configuration (cost-effective setup: 4GB RAM, 40GB storage, IPv4/IPv6, SSH keys)


Continue to [1b.nixOS and Bonfire deployment experiments and documentation](./1b.md) to read about our experimental deployments